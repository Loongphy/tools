name: Build nginx (aarch64 musl static)

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: 'Nginx version'
        required: true
        default: '1.26.2'
      openssl_version:
        description: 'OpenSSL version'
        required: true
        default: '3.2.1'
      pcre_version:
        description: 'PCRE version'
        required: true
        default: '8.45'
      zlib_version:
        description: 'zlib version'
        required: true
        default: '1.3.1'

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential musl-tools musl-dev \
            pkg-config perl wget ca-certificates tar xz-utils

      - name: Download sources
        run: |
          set -e
          wget -q https://nginx.org/download/nginx-${{ inputs.nginx_version }}.tar.gz
          wget -q https://www.openssl.org/source/openssl-${{ inputs.openssl_version }}.tar.gz
          wget -q https://downloads.sourceforge.net/project/pcre/pcre/${{ inputs.pcre_version }}/pcre-${{ inputs.pcre_version }}.tar.gz
          wget -q https://zlib.net/zlib-${{ inputs.zlib_version }}.tar.gz

          tar -xzf nginx-${{ inputs.nginx_version }}.tar.gz
          tar -xzf openssl-${{ inputs.openssl_version }}.tar.gz
          tar -xzf pcre-${{ inputs.pcre_version }}.tar.gz
          tar -xzf zlib-${{ inputs.zlib_version }}.tar.gz

      - name: Build nginx (static musl)
        run: |
          set -e
          cd nginx-${{ inputs.nginx_version }}

          CC=musl-gcc ./configure \
            --prefix=/opt/nginx \
            --sbin-path=/opt/nginx/sbin/nginx \
            --conf-path=/opt/nginx/conf/nginx.conf \
            --error-log-path=/opt/nginx/logs/error.log \
            --http-log-path=/opt/nginx/logs/access.log \
            --pid-path=/opt/nginx/run/nginx.pid \
            --lock-path=/opt/nginx/run/nginx.lock \
            --with-cc-opt="-static -O2" \
            --with-ld-opt="-static -static-libgcc" \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_gzip_static_module \
            --with-http_realip_module \
            --with-http_stub_status_module \
            --with-stream \
            --with-stream_ssl_module \
            --with-pcre=../pcre-${{ inputs.pcre_version }} \
            --with-pcre-jit \
            --with-pcre-opt="--enable-jit" \
            --with-zlib=../zlib-${{ inputs.zlib_version }} \
            --with-zlib-opt="--static" \
            --with-openssl=../openssl-${{ inputs.openssl_version }} \
            --with-openssl-opt="no-shared no-dso no-tests -fPIC"

          make -j"$(nproc)"

          file objs/nginx
          strip objs/nginx
          ls -lh objs/nginx
          ldd objs/nginx || echo "Static binary confirmed"

          mkdir -p /tmp/pkg/nginx/sbin
          cp objs/nginx /tmp/pkg/nginx/sbin/nginx
          tar -C /tmp/pkg -czf /tmp/nginx-${{ inputs.nginx_version }}-aarch64-musl-static.tar.gz nginx
          sha256sum /tmp/nginx-${{ inputs.nginx_version }}-aarch64-musl-static.tar.gz > /tmp/nginx-${{ inputs.nginx_version }}-aarch64-musl-static.tar.gz.sha256

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ inputs.nginx_version }}-aarch64-musl-static
          path: /tmp/nginx-${{ inputs.nginx_version }}-aarch64-musl-static.tar.gz
          retention-days: 30

      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ inputs.nginx_version }}-aarch64-musl-static-sha256
          path: /tmp/nginx-${{ inputs.nginx_version }}-aarch64-musl-static.tar.gz.sha256
          retention-days: 30
