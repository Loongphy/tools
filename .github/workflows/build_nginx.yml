name: Build Static Nginx (ARM64)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    name: Build Static Nginx
    runs-on: ubuntu-24.04-arm
    
    container:
      image: alpine:latest
      # 建议：确保容器以 root 运行（虽然 Alpine 默认就是，但显式声明更安全）
      options: --user root

    env:
      # 更新到最新稳定版 (截至 2025-02-06，Nginx 1.26.3 是最新稳定版)
      NGINX_VERSION: 1.26.3
      # OpenSSL 3.3.x 没问题，但要注意 3.x 编译速度比 1.1.1 慢很多
      OPENSSL_VERSION: 3.3.0
      PCRE2_VERSION: 10.43
      ZLIB_VERSION: 1.3.1

    steps:
      - name: Install Build Dependencies
        # 增加 tar 和 strip (binutils)
        run: |
          apk update
          apk add build-base curl linux-headers perl bash tar binutils

      - name: Download Sources
        run: |
          mkdir -p /build
          cd /build

          # 定义通用 Curl 参数，模拟浏览器 User-Agent 避免 403，并跟随重定向
          CURL_OPTS="-L -H 'User-Agent: Mozilla/5.0' --fail --silent --show-error"

          echo "Downloading Nginx..."
          curl $CURL_OPTS -O http://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz
          tar zxf nginx-${NGINX_VERSION}.tar.gz

          echo "Downloading OpenSSL..."
          curl $CURL_OPTS -O https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VERSION}/openssl-${OPENSSL_VERSION}.tar.gz
          tar zxf openssl-${OPENSSL_VERSION}.tar.gz

          echo "Downloading PCRE2..."
          curl $CURL_OPTS -O https://github.com/PCRE2Project/pcre2/releases/download/pcre2-${PCRE2_VERSION}/pcre2-${PCRE2_VERSION}.tar.gz
          tar zxf pcre2-${PCRE2_VERSION}.tar.gz

          echo "Downloading Zlib..."
          curl $CURL_OPTS -O https://github.com/madler/zlib/releases/download/v${ZLIB_VERSION}/zlib-${ZLIB_VERSION}.tar.gz
          tar zxf zlib-${ZLIB_VERSION}.tar.gz

      - name: Compile Static Nginx
        run: |
          cd /build/nginx-${NGINX_VERSION}

          # 检查目录是否存在，防止 tar 解压路径不一致导致的错误
          ls -F ../

          ./configure \
            --prefix=/etc/nginx \
            --sbin-path=/usr/sbin/nginx \
            --conf-path=/etc/nginx/nginx.conf \
            --pid-path=/var/run/nginx.pid \
            --lock-path=/var/run/nginx.lock \
            --error-log-path=/var/log/nginx/error.log \
            --http-log-path=/var/log/nginx/access.log \
            --with-pcre=../pcre2-${PCRE2_VERSION} \
            --with-zlib=../zlib-${ZLIB_VERSION} \
            --with-openssl=../openssl-${OPENSSL_VERSION} \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_gzip_static_module \
            --with-http_stub_status_module \
            --with-stream \
            --with-stream_ssl_module \
            --with-file-aio \
            --with-threads \
            --with-cc-opt="-static -static-libgcc -O2" \
            --with-ld-opt="-static"

          # 使用 4 线程编译，避免在某些共享 Runner 上 OOM
          make -j4
          
          # 关键优化：Strip 去除符号表，减小体积
          strip -s objs/nginx
          
          cp objs/nginx /tmp/nginx-aarch64-static

      - name: Verify Binary
        run: |
          cd /tmp
          
          echo "=== File Type ==="
          file nginx-aarch64-static
          
          echo "=== Dependencies (Must return empty or 'not a dynamic executable') ==="
          ldd nginx-aarch64-static 2>&1 || true
          
          echo "=== Version Info ==="
          ./nginx-aarch64-static -V

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-aarch64-static
          path: /tmp/nginx-aarch64-static
          retention-days: 5