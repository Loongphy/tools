name: Build nginx (aarch64 musl static)

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: 'Nginx version'
        required: true
        default: '1.26.2'
      openssl_version:
        description: 'OpenSSL version'
        required: true
        default: '3.2.1'
      pcre2_version:
        description: 'PCRE2 version'
        required: true
        default: '10.43'
      zlib_version:
        description: 'zlib version'
        required: true
        default: '1.3.1'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install cross-compilation toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar make

          # 下载 musl cross compiler for aarch64
          wget -q https://musl.cc/aarch64-linux-musl-cross.tgz
          tar -xzf aarch64-linux-musl-cross.tgz
          echo "$PWD/aarch64-linux-musl-cross/bin" >> $GITHUB_PATH

      - name: Download sources
        run: |
          wget -q https://nginx.org/download/nginx-${{ inputs.nginx_version }}.tar.gz
          wget -q https://github.com/openssl/openssl/releases/download/openssl-${{ inputs.openssl_version }}/openssl-${{ inputs.openssl_version }}.tar.gz
          wget -q https://github.com/PCRE2Project/pcre2/releases/download/pcre2-${{ inputs.pcre2_version }}/pcre2-${{ inputs.pcre2_version }}.tar.gz
          wget -q https://zlib.net/zlib-${{ inputs.zlib_version }}.tar.gz

          tar -xzf nginx-${{ inputs.nginx_version }}.tar.gz
          tar -xzf openssl-${{ inputs.openssl_version }}.tar.gz
          tar -xzf pcre2-${{ inputs.pcre2_version }}.tar.gz
          tar -xzf zlib-${{ inputs.zlib_version }}.tar.gz

      - name: Build nginx
        env:
          CC: aarch64-linux-musl-gcc
          CXX: aarch64-linux-musl-g++
          AR: aarch64-linux-musl-ar
          RANLIB: aarch64-linux-musl-ranlib
          CFLAGS: "-static -O2"
          LDFLAGS: "-static"
        run: |
          cd nginx-${{ inputs.nginx_version }}

          ./configure \
            --prefix=/opt/nginx \
            --with-cc=aarch64-linux-musl-gcc \
            --with-cc-opt="-static -O2" \
            --with-ld-opt="-static" \
            --with-cpu-opt=aarch64 \
            --crossbuild=Linux:aarch64 \
            --with-pcre=../pcre2-${{ inputs.pcre2_version }} \
            --with-zlib=../zlib-${{ inputs.zlib_version }} \
            --with-openssl=../openssl-${{ inputs.openssl_version }} \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_gzip_static_module \
            --with-http_realip_module \
            --with-http_stub_status_module \
            --with-stream \
            --with-stream_ssl_module \
            --without-http_fastcgi_module \
            --without-http_uwsgi_module \
            --without-http_scgi_module \
            --without-http_grpc_module

          make -j$(nproc)

      - name: Verify binary
        run: |
          file nginx-${{ inputs.nginx_version }}/objs/nginx
          aarch64-linux-musl-strip nginx-${{ inputs.nginx_version }}/objs/nginx
          ls -lh nginx-${{ inputs.nginx_version }}/objs/nginx

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ inputs.nginx_version }}-aarch64-musl-static
          path: nginx-${{ inputs.nginx_version }}/objs/nginx
          retention-days: 30
