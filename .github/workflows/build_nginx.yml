name: Build nginx (aarch64 musl static)

on:
  push:
  workflow_dispatch:

env:
  NGINX_VERSION: '1.26.2'
  OPENSSL_VERSION: '3.2.1'
  PCRE_VERSION: '8.45'
  ZLIB_VERSION: '1.3.1'

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential musl-tools musl-dev \
            pkg-config perl wget ca-certificates tar xz-utils

      - name: Download sources
        run: |
          set -e
          wget -q https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz
          wget -q https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
          wget -q https://downloads.sourceforge.net/project/pcre/pcre/${PCRE_VERSION}/pcre-${PCRE_VERSION}.tar.gz
          wget -q https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz

          tar -xzf nginx-${NGINX_VERSION}.tar.gz
          tar -xzf openssl-${OPENSSL_VERSION}.tar.gz
          tar -xzf pcre-${PCRE_VERSION}.tar.gz
          tar -xzf zlib-${ZLIB_VERSION}.tar.gz

      - name: Build nginx (static musl)
        run: |
          set -e
          cd nginx-${NGINX_VERSION}

          CC=musl-gcc ./configure \
            --prefix=/opt/nginx \
            --sbin-path=/opt/nginx/sbin/nginx \
            --conf-path=/opt/nginx/conf/nginx.conf \
            --error-log-path=/opt/nginx/logs/error.log \
            --http-log-path=/opt/nginx/logs/access.log \
            --pid-path=/opt/nginx/run/nginx.pid \
            --lock-path=/opt/nginx/run/nginx.lock \
            --with-cc-opt="-static -O2" \
            --with-ld-opt="-static -static-libgcc" \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_gzip_static_module \
            --with-http_realip_module \
            --with-http_stub_status_module \
            --with-stream \
            --with-stream_ssl_module \
            --with-pcre=../pcre-${PCRE_VERSION} \
            --with-pcre-jit \
            --with-pcre-opt="--enable-jit" \
            --with-zlib=../zlib-${ZLIB_VERSION} \
            --with-zlib-opt="--static" \
            --with-openssl=../openssl-${OPENSSL_VERSION} \
            --with-openssl-opt="no-shared no-dso no-tests -fPIC"

          make -j"$(nproc)"

          file objs/nginx
          strip objs/nginx
          ls -lh objs/nginx
          ldd objs/nginx || echo "Static binary confirmed"

          mkdir -p /tmp/pkg/nginx/sbin
          cp objs/nginx /tmp/pkg/nginx/sbin/nginx
          tar -C /tmp/pkg -czf /tmp/nginx-${NGINX_VERSION}-aarch64-musl-static.tar.gz nginx
          sha256sum /tmp/nginx-${NGINX_VERSION}-aarch64-musl-static.tar.gz > /tmp/nginx-${NGINX_VERSION}-aarch64-musl-static.tar.gz.sha256

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ env.NGINX_VERSION }}-aarch64-musl-static
          path: /tmp/nginx-${NGINX_VERSION}-aarch64-musl-static.tar.gz
          retention-days: 30

      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: nginx-${{ env.NGINX_VERSION }}-aarch64-musl-static-sha256
          path: /tmp/nginx-${NGINX_VERSION}-aarch64-musl-static.tar.gz.sha256
          retention-days: 30