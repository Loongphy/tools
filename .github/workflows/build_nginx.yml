name: Build nginx (aarch64 musl static)

on:
  push:
  workflow_dispatch:

env:
  NGINX_VERSION: "1.26.2"
  OPENSSL_VERSION: "3.2.1"
  PCRE_VERSION: "8.45"
  ZLIB_VERSION: "1.3.1"

jobs:
  build-static:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Derive artifact names
        run: |
          set -eux
          echo "ARTIFACT_PATH=/tmp/nginx-${NGINX_VERSION}-aarch64-musl-static.tar.gz" >> "$GITHUB_ENV"
          echo "CHECKSUM_PATH=/tmp/nginx-${NGINX_VERSION}-aarch64-musl-static.tar.gz.sha256" >> "$GITHUB_ENV"
          echo "ARTIFACT_NAME=nginx-${NGINX_VERSION}-aarch64-musl-static" >> "$GITHUB_ENV"
          echo "CHECKSUM_NAME=nginx-${NGINX_VERSION}-aarch64-musl-static-sha256" >> "$GITHUB_ENV"

      - name: Install build dependencies
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            build-essential musl-dev musl-tools \
            pkg-config perl wget ca-certificates tar xz-utils

      - name: Download sources
        run: |
          set -eux
          wget -q https://nginx.org/download/nginx-${NGINX_VERSION}.tar.gz
          wget -q https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
          wget -q https://downloads.sourceforge.net/project/pcre/pcre/${PCRE_VERSION}/pcre-${PCRE_VERSION}.tar.gz
          wget -q https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz

          tar -xzf nginx-${NGINX_VERSION}.tar.gz
          tar -xzf openssl-${OPENSSL_VERSION}.tar.gz
          tar -xzf pcre-${PCRE_VERSION}.tar.gz
          tar -xzf zlib-${ZLIB_VERSION}.tar.gz

      - name: Build nginx (static musl)
        working-directory: nginx-${{ env.NGINX_VERSION }}
        run: |
          set -eux

          CC=musl-gcc ./configure \
            --prefix=/opt/nginx \
            --sbin-path=/opt/nginx/sbin/nginx \
            --conf-path=/opt/nginx/conf/nginx.conf \
            --error-log-path=/opt/nginx/logs/error.log \
            --http-log-path=/opt/nginx/logs/access.log \
            --pid-path=/opt/nginx/run/nginx.pid \
            --lock-path=/opt/nginx/run/nginx.lock \
            --with-cc-opt="-static -O2 -I/usr/include" \
            --with-ld-opt="-static" \
            --without-http_auth_basic_module \
            --with-http_ssl_module \
            --with-http_v2_module \
            --with-http_gzip_static_module \
            --with-http_realip_module \
            --with-http_stub_status_module \
            --with-stream \
            --with-stream_ssl_module \
            --with-pcre=../pcre-${PCRE_VERSION} \
            --with-pcre-jit \
            --with-zlib=../zlib-${ZLIB_VERSION} \
            --with-openssl=../openssl-${OPENSSL_VERSION} \
            --with-openssl-opt="no-shared no-dso no-tests"

          make -j"$(nproc)"

          file objs/nginx
          ldd objs/nginx || true
          file objs/nginx | grep -q "statically linked"

      - name: Package artifacts
        run: |
          set -eux
          mkdir -p /tmp/pkg/nginx/sbin
          cp nginx-${NGINX_VERSION}/objs/nginx /tmp/pkg/nginx/sbin/nginx
          tar -C /tmp/pkg -czf "${ARTIFACT_PATH}" nginx
          sha256sum "${ARTIFACT_PATH}" > "${CHECKSUM_PATH}"

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_PATH }}
          retention-days: 30

      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.CHECKSUM_NAME }}
          path: ${{ env.CHECKSUM_PATH }}
          retention-days: 30
